<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizador de Pedidos con Mapa de Rutas</title>
    <!-- Incluyendo Tailwind CSS para un dise帽o moderno -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- LeafletJS para el mapa interactivo -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <!-- Leaflet Routing Machine para crear rutas -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Estilo para el contenedor del mapa */
        #map { 
            height: 450px; 
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        /* Ocultar el panel de instrucciones de la ruta por defecto */
        .leaflet-routing-container {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8 max-w-4xl">

        <!-- Cabecera -->
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900"> Organizador de Pedidos y Rutas</h1>
            <p class="text-gray-600 mt-2">A帽ade pedidos para ver los marcadores y la ruta de entrega en el mapa.</p>
        </header>

        <!-- Formulario para agregar nuevos pedidos -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2">A帽adir Nuevo Pedido</h2>
            <form id="form-pedido">
                <div class="grid md:grid-cols-2 gap-4">
                    <!-- Campo: Nombre del Cliente -->
                    <div class="mb-4">
                        <label for="nombre-cliente" class="block text-sm font-medium text-gray-700 mb-1">Nombre del Cliente</label>
                        <input type="text" id="nombre-cliente" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="Ej: Juan P茅rez">
                    </div>

                    <!-- Campo: Descripci贸n del Pedido -->
                    <div class="mb-4">
                        <label for="descripcion-pedido" class="block text-sm font-medium text-gray-700 mb-1">Descripci贸n del Pedido</label>
                        <input type="text" id="descripcion-pedido" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="Ej: 2 pizzas, 1 refresco">
                    </div>
                </div>

                <!-- Campo: Direcci贸n -->
                <div class="mb-4">
                    <label for="direccion" class="block text-sm font-medium text-gray-700 mb-1">Direcci贸n o Enlace de Google Maps</label>
                    <input type="text" id="direccion" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition duration-150 ease-in-out" placeholder="Ej: Av. Monse帽or Rivero o https://maps.app.goo.gl/...">
                    <p class="text-xs text-gray-500 mt-1">Pega una direcci贸n, un enlace corto o completo de Google Maps.</p>
                </div>
                 <p id="address-error" class="text-red-500 text-sm mb-4 hidden"></p>

                <!-- Bot贸n de env铆o -->
                <div class="text-right">
                    <button type="submit" id="submit-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                        Agregar Pedido
                    </button>
                </div>
            </form>
        </div>

        <!-- Contenedor del Mapa -->
        <div id="map" class="mb-8"></div>

        <!-- Lista de pedidos pendientes -->
        <div>
            <h2 class="text-2xl font-semibold mb-4 border-b pb-2"> Pedidos Pendientes</h2>
            <div id="lista-pedidos" class="space-y-4">
                <!-- Mensaje inicial cuando no hay pedidos -->
                <div id="mensaje-vacio" class="text-center py-10 px-6 bg-white rounded-xl shadow-md">
                    <p class="text-gray-500">A煤n no has agregado ning煤n pedido.</p>
                    <p class="text-sm text-gray-400 mt-1">Usa el formulario de arriba para empezar.</p>
                </div>
                <!-- Los pedidos se agregar谩n aqu铆 din谩micamente -->
            </div>
        </div>

    </div>

    <script>
        // --- INICIALIZACIN DEL MAPA ---
        const initialCoords = [-17.7833, -63.1821]; // Coordenadas iniciales (Santa Cruz de la Sierra)
        const map = L.map('map').setView(initialCoords, 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // --- GESTIN DE DATOS Y ESTADO ---
        const pedidos = [];
        let markers = {};
        let routingControl = null;

        // --- ELEMENTOS DEL DOM ---
        const formPedido = document.getElementById('form-pedido');
        const nombreClienteInput = document.getElementById('nombre-cliente');
        const descripcionPedidoInput = document.getElementById('descripcion-pedido');
        const direccionInput = document.getElementById('direccion');
        const listaPedidos = document.getElementById('lista-pedidos');
        const mensajeVacio = document.getElementById('mensaje-vacio');
        const addressError = document.getElementById('address-error');
        const submitButton = document.getElementById('submit-button');

        // --- FUNCIONES AUXILIARES ---
        function actualizarVistaVacia() {
            mensajeVacio.style.display = pedidos.length === 0 ? 'block' : 'none';
        }

        function actualizarRuta() {
            if (routingControl) {
                map.removeControl(routingControl);
            }
            if (pedidos.length < 2) {
                return;
            }
            const waypoints = pedidos.map(p => L.latLng(p.lat, p.lon));
            routingControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                addWaypoints: false,
                draggableWaypoints: false,
                createMarker: function() { return null; } // Evita marcadores duplicados en la ruta
            }).addTo(map);
        }
        
        function renderizarListaPedidos() {
            listaPedidos.innerHTML = '';
            listaPedidos.appendChild(mensajeVacio);
            pedidos.forEach(pedido => {
                const elementoPedido = document.createElement('div');
                elementoPedido.className = 'bg-white p-4 rounded-xl shadow-md flex flex-col md:flex-row items-start md:items-center justify-between gap-4 transition-transform duration-300 hover:shadow-lg hover:-translate-y-1';
                elementoPedido.dataset.id = pedido.id;
                elementoPedido.innerHTML = `
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg text-gray-900">${pedido.cliente}</h3>
                        <p class="text-gray-600">${pedido.descripcion}</p>
                        <p class="text-xs text-gray-500 mt-1">${pedido.direccion}</p>
                    </div>
                    <div class="flex items-center space-x-2 w-full md:w-auto flex-shrink-0">
                        <button data-accion="ver-en-mapa" data-id="${pedido.id}" class="w-1/2 md:w-auto text-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">Ver en Mapa</button>
                        <button data-accion="eliminar" data-id="${pedido.id}" class="w-1/2 md:w-auto bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 text-sm">Eliminar</button>
                    </div>`;
                listaPedidos.appendChild(elementoPedido);
            });
            actualizarVistaVacia();
        }

        // --- MANEJADORES DE EVENTOS ---
        formPedido.addEventListener('submit', async function(event) {
            event.preventDefault();
            addressError.classList.add('hidden');
            submitButton.disabled = true;
            submitButton.textContent = 'Buscando...';

            const nombreCliente = nombreClienteInput.value.trim();
            const descripcionPedido = descripcionPedidoInput.value.trim();
            const direccionOriginal = direccionInput.value.trim();

            try {
                let finalAddress = direccionOriginal;

                // Caso 1: Detectar y resolver enlace corto de Google Maps
                if (finalAddress.includes('maps.app.goo.gl')) {
                    submitButton.textContent = 'Resolviendo enlace...';
                    
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 7000); // 7-second timeout

                    try {
                        // Usando un proxy CORS para obtener la URL de redirecci贸n final
                        const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(finalAddress)}`;
                        const response = await fetch(proxyUrl, { signal: controller.signal });
                        clearTimeout(timeoutId);

                        if (!response.ok) {
                            throw new Error('El servicio para convertir enlaces cortos fall贸. Int茅ntalo de nuevo o pega el enlace largo de Google Maps manualmente.');
                        }
                        const data = await response.json();
                        const longUrl = data.status.url;

                        if (!longUrl || longUrl === finalAddress) {
                            throw new Error('No se pudo convertir el enlace corto. Por favor, 谩brelo en tu navegador y pega el enlace completo.');
                        }
                        finalAddress = longUrl;
                        submitButton.textContent = 'Buscando...';
                    } catch (err) {
                        clearTimeout(timeoutId);
                        if (err.name === 'AbortError') {
                            throw new Error('La conversi贸n del enlace tard贸 demasiado. Revisa tu conexi贸n o pega el enlace completo manualmente.');
                        }
                         // Re-lanzar el error para que sea atrapado por el bloque catch principal.
                        throw err;
                    }
                }

                // Regex para varios formatos de URL de Google Maps
                const googleMapsAtRegex = /@(-?\d+\.\d+),(-?\d+\.\d+)/;
                const googleMapsQRegex = /maps\?q=([\-0-9\.]+)[,%2C\s]+([\-0-9\.]+)/;
                
                const matchAt = finalAddress.match(googleMapsAtRegex);
                const matchQ = finalAddress.match(googleMapsQRegex);

                let lat, lon, displayAddress;

                if (matchAt && matchAt.length >= 3) {
                    lat = parseFloat(matchAt[1]);
                    lon = parseFloat(matchAt[2]);
                    displayAddress = "Ubicaci贸n desde enlace";
                } else if (matchQ && matchQ.length >= 3) {
                    lat = parseFloat(matchQ[1]);
                    lon = parseFloat(matchQ[2]);
                    displayAddress = "Ubicaci贸n desde enlace";
                } else {
                    const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(finalAddress)}`);
                    const data = await response.json();
                    if (data.length === 0) {
                        throw new Error("No se pudo encontrar la direcci贸n. Intenta ser m谩s espec铆fico.");
                    }
                    lat = data[0].lat;
                    lon = data[0].lon;
                    displayAddress = finalAddress;
                }

                const id = Date.now();
                const marker = L.marker([lat, lon]).addTo(map).bindPopup(`<b>${nombreCliente}</b><br>${descripcionPedido}`);
                markers[id] = marker;
                pedidos.push({ id, cliente: nombreCliente, descripcion: descripcionPedido, direccion: displayAddress, lat, lon });
                
                renderizarListaPedidos();
                actualizarRuta();
                formPedido.reset();
                nombreClienteInput.focus();

            } catch (err) {
                addressError.textContent = err.message;
                addressError.classList.remove('hidden');
            } finally {
                submitButton.disabled = false;
                submitButton.textContent = 'Agregar Pedido';
            }
        });

        listaPedidos.addEventListener('click', function(event) {
            const accion = event.target.dataset.accion;
            const id = event.target.dataset.id;
            if (!accion || !id) return;

            const pedidoId = parseInt(id);

            if (accion === 'eliminar') {
                const index = pedidos.findIndex(p => p.id === pedidoId);
                if (index > -1) pedidos.splice(index, 1);
                
                if (markers[pedidoId]) {
                    map.removeLayer(markers[pedidoId]);
                    delete markers[pedidoId];
                }
                renderizarListaPedidos();
                actualizarRuta();
            } else if (accion === 'ver-en-mapa') {
                const marker = markers[pedidoId];
                if (marker) {
                    map.flyTo(marker.getLatLng(), 15);
                    marker.openPopup();
                }
            }
        });

        // --- LLAMADA INICIAL ---
        actualizarVistaVacia();
    </script>

</body>
</html>

